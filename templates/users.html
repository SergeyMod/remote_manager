{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-users"></i> Управление пользователями</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-plus"></i> Создать пользователя
        </button>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Логин</th>
                <th>Пароль</th>
                <th>Дата создания</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody id="users-table">
            <tr>
                <td colspan="5" class="loading">Загрузка пользователей...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Модальное окно создания/редактирования пользователя -->
<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="user-modal-title">Создать пользователя</h3>
            <button class="close-btn" onclick="closeUserModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="user-form">
                <input type="hidden" id="user-id">

                <div class="form-group">
                    <label for="user-username">Логин *</label>
                    <input type="text" id="user-username" required>
                </div>

                <div class="form-group">
                    <label for="user-password">Пароль *</label>
                    <input type="text" id="user-password" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                    <button type="button" class="btn" onclick="closeUserModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Вспомогательные функции для users.html
function showToast(message, type = 'info') {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000;';
        document.body.appendChild(container);
    }

    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Специфичные функции для страницы пользователей
function showAddUserModal() {
    document.getElementById('user-id').value = '';
    document.getElementById('user-username').value = '';
    document.getElementById('user-password').value = '';
    document.getElementById('user-modal-title').textContent = 'Создать пользователя';
    document.getElementById('user-modal').style.display = 'flex';
}

function closeUserModal() {
    document.getElementById('user-modal').style.display = 'none';
}

async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const users = await response.json();

        updateUsersTable(users);
    } catch (error) {
        console.error('Error loading users:', error);
        showToast('Ошибка загрузки пользователей', 'error');
    }
}

function updateUsersTable(users) {
    const tbody = document.getElementById('users-table');

    if (!users || users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-users" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                    <div>Пользователи не найдены</div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';

    users.forEach(user => {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span id="password-${user.id}" style="font-family: monospace;">${'*'.repeat(user.password ? user.password.length : 0)}</span>
                    <button class="btn btn-sm" onclick="togglePassword(${user.id}, '${user.password}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
            <td>${new Date(user.created_at).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-secondary" onclick="editUser(${user.id})">
                    <i class="fas fa-edit"></i> Редактировать
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">
                    <i class="fas fa-trash"></i> Удалить
                </button>
            </td>
        `;

        tbody.appendChild(row);
    });
}

function togglePassword(userId, realPassword) {
    const span = document.getElementById(`password-${userId}`);
    if (!span) return;

    if (span.textContent.includes('*')) {
        span.textContent = realPassword || '';
        setTimeout(() => {
            span.textContent = '*'.repeat(realPassword ? realPassword.length : 0);
        }, 3000);
    } else {
        span.textContent = '*'.repeat(realPassword ? realPassword.length : 0);
    }
}

async function saveUser(e) {
    if (e) e.preventDefault();

    const userId = document.getElementById('user-id').value;
    const username = document.getElementById('user-username').value;
    const password = document.getElementById('user-password').value;

    if (!username || !password) {
        showToast('Заполните все поля', 'error');
        return;
    }

    const userData = {
        username: username,
        password: password
    };

    try {
        let response;
        if (userId) {
            response = await fetch(`/api/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        } else {
            response = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        }

        if (response.ok) {
            showToast(`Пользователь ${userId ? 'обновлен' : 'создан'}`, 'success');
            closeUserModal();
            loadUsers();
        } else {
            const error = await response.json();
            showToast(`Ошибка: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error saving user:', error);
        showToast('Ошибка сохранения пользователя', 'error');
    }
}

async function editUser(userId) {
    try {
        const response = await fetch(`/api/users/${userId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const user = await response.json();

        document.getElementById('user-id').value = user.id;
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-password').value = user.password;
        document.getElementById('user-modal-title').textContent = 'Редактировать пользователя';
        document.getElementById('user-modal').style.display = 'flex';
    } catch (error) {
        console.error('Error loading user:', error);
        showToast('Ошибка загрузки пользователя', 'error');
    }
}

async function deleteUser(userId) {
    if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) return;

    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Пользователь удален', 'success');
            loadUsers();
        } else {
            const error = await response.json();
            showToast(`Ошибка: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Ошибка удаления пользователя', 'error');
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();

    const userForm = document.getElementById('user-form');
    if (userForm) {
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();
            saveUser(e);
        });
    }
});
</script>

<style>
/* Стили для тостов */
#toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    border-radius: 5px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s;
}

.toast-success {
    border-left: 4px solid #48bb78;
}

.toast-error {
    border-left: 4px solid #f56565;
}

.toast-info {
    border-left: 4px solid #4299e1;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %}