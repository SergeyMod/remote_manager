{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-list-alt"></i> Управление профилями</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="showAddProfileModal()">
            <i class="fas fa-plus"></i> Создать профиль
        </button>
    </div>
</div>

<div class="profiles-grid" id="profiles-container">
    <!-- Профили будут загружены через JavaScript -->
    <div class="loading">Загрузка профилей...</div>
</div>

<!-- Модальное окно создания/редактирования профиля -->
<div id="profile-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="profile-modal-title">Создать профиль</h3>
            <button class="close-btn" onclick="closeProfileModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="profile-form">
                <input type="hidden" id="profile-id">
                
                <div class="form-group">
                    <label for="profile-name">Название профиля *</label>
                    <input type="text" id="profile-name" required>
                </div>
                
                <div id="profile-scripts-container">
                    <h4>Сценарии профиля:</h4>
                    <div id="profile-scripts-list">
                        <!-- Строки сценариев будут добавляться динамически -->
                    </div>
                    <button type="button" class="btn btn-sm" onclick="addProfileScriptRow()">
                        <i class="fas fa-plus"></i> Добавить сценарий
                    </button>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить профиль
                    </button>
                    <button type="button" class="btn" onclick="closeProfileModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно запуска профиля -->
<div id="execute-profile-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Запуск профиля</h3>
            <button class="close-btn" onclick="closeExecuteProfileModal()">&times;</button>
        </div>
        <div class="modal-body">
            <h4 id="execute-profile-name"></h4>
            <p>Профиль будет выполнен последовательно на указанных машинах.</p>
            
            <div id="profile-progress" style="display: none;">
                <h5>Прогресс выполнения:</h5>
                <div id="progress-bar-container" style="margin: 1rem 0;">
                    <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div id="progress-bar" style="background: #48bb78; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="progress-text" style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem;"></div>
                </div>
                
                <div id="execution-log" style="max-height: 300px; overflow-y: auto; 
                                            background: #f7fafc; padding: 1rem; 
                                            border-radius: 5px; font-family: monospace; 
                                            font-size: 0.85rem;"></div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-primary" onclick="executeProfile()" id="start-execute-btn">
                    <i class="fas fa-play"></i> Запустить профиль
                </button>
                <button class="btn" onclick="closeExecuteProfileModal()">Отмена</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentProfileId = null;
let profileScripts = [];
let scriptsCache = [];
let machinesCache = [];

document.addEventListener('DOMContentLoaded', function() {
    loadProfiles();
    loadScriptsAndMachines();
    
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveProfile();
    });
});

async function loadProfiles() {
    try {
        const response = await fetch('/api/profiles');
        const profiles = await response.json();
        
        const container = document.getElementById('profiles-container');
        
        if (profiles.length === 0) {
            container.innerHTML = `
                <div class="loading">
                    <i class="fas fa-list-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                    <div>Нет профилей. Создайте первый профиль.</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = '';
        
        for (const profile of profiles) {
            // Загружаем детали профиля
            const profileDetail = await fetch(`/api/profiles/${profile.id}`)
                .then(r => r.json())
                .catch(() => ({ scripts: [] }));
            
            const card = document.createElement('div');
            card.className = 'machine-card';
            
            card.innerHTML = `
                <div class="machine-header">
                    <div class="machine-title">
                        <i class="fas fa-layer-group"></i> ${profile.name}
                    </div>
                    <div>
                        <span class="machine-status status-info">
                            ${profileDetail.scripts.length} сценариев
                        </span>
                    </div>
                </div>
                <div class="machine-info">
                    <div style="font-size: 0.9rem; color: #666;">
                        ${profileDetail.scripts.length === 0 ? 'Нет сценариев' : 
                          profileDetail.scripts.map(s => s.script_name).join(', ')}
                    </div>
                </div>
                <div class="machine-actions">
                    <button class="btn btn-sm btn-primary" onclick="showExecuteProfileModal(${profile.id})">
                        <i class="fas fa-play"></i> Запустить
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="editProfile(${profile.id})">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProfile(${profile.id})">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                </div>
            `;
            
            container.appendChild(card);
        }
    } catch (error) {
        console.error('Error loading profiles:', error);
        showToast('Ошибка загрузки профилей', 'error');
    }
}

async function loadScriptsAndMachines() {
    try {
        // Загружаем скрипты и машины для кэша
        const [scriptsRes, machinesRes] = await Promise.all([
            fetch('/api/scripts'),
            fetch('/api/machines')
        ]);
        
        scriptsCache = await scriptsRes.json();
        machinesCache = await machinesRes.json();
    } catch (error) {
        console.error('Error loading data for cache:', error);
    }
}

function showAddProfileModal() {
    document.getElementById('profile-id').value = '';
    document.getElementById('profile-name').value = '';
    profileScripts = [];
    renderProfileScripts();
    document.getElementById('profile-modal-title').textContent = 'Создать профиль';
    document.getElementById('profile-modal').style.display = 'flex';
}

function closeProfileModal() {
    document.getElementById('profile-modal').style.display = 'none';
}

function addProfileScriptRow(scriptData = null) {
    const rowId = Date.now() + Math.random();
    
    profileScripts.push({
        id: rowId,
        script_id: scriptData?.script_id || '',
        machine_ids: scriptData?.machine_ids || [],
        order_index: profileScripts.length
    });
    
    renderProfileScripts();
}

function removeProfileScriptRow(rowId) {
    profileScripts = profileScripts.filter(ps => ps.id !== rowId);
    // Обновляем order_index
    profileScripts.forEach((ps, index) => {
        ps.order_index = index;
    });
    renderProfileScripts();
}

function moveProfileScriptRow(rowId, direction) {
    const index = profileScripts.findIndex(ps => ps.id === rowId);
    if (index === -1) return;
    
    if (direction === 'up' && index > 0) {
        [profileScripts[index], profileScripts[index - 1]] = [profileScripts[index - 1], profileScripts[index]];
    } else if (direction === 'down' && index < profileScripts.length - 1) {
        [profileScripts[index], profileScripts[index + 1]] = [profileScripts[index + 1], profileScripts[index]];
    }
    
    // Обновляем order_index
    profileScripts.forEach((ps, idx) => {
        ps.order_index = idx;
    });
    
    renderProfileScripts();
}

function renderProfileScripts() {
    const container = document.getElementById('profile-scripts-list');
    container.innerHTML = '';
    
    profileScripts.forEach((ps, index) => {
        const row = document.createElement('div');
        row.className = 'profile-script-row';
        row.id = `profile-script-${ps.id}`;
        
        // Создаем select для скриптов
        let scriptSelect = `<select class="script-select" data-row-id="${ps.id}" onchange="updateScriptSelection('${ps.id}', this.value)">
            <option value="">Выберите сценарий</option>`;
        
        scriptsCache.forEach(script => {
            scriptSelect += `<option value="${script.id}" ${ps.script_id == script.id ? 'selected' : ''}>
                ${script.name}
            </option>`;
        });
        
        scriptSelect += '</select>';
        
        // Создаем multiselect для машин
        let machineSelect = `<select class="machine-select" data-row-id="${ps.id}" multiple 
                           onchange="updateMachineSelection('${ps.id}', this)" 
                           style="min-width: 200px; min-height: 100px;">`;
        
        machinesCache.forEach(machine => {
            const selected = ps.machine_ids.includes(machine.id.toString()) || 
                            ps.machine_ids.includes(machine.id);
            machineSelect += `<option value="${machine.id}" ${selected ? 'selected' : ''}>
                ${machine.name} (${machine.address})
            </option>`;
        });
        
        machineSelect += '</select>';
        
        row.innerHTML = `
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button type="button" class="btn btn-sm" onclick="moveProfileScriptRow('${ps.id}', 'up')" ${index === 0 ? 'disabled' : ''}>
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm" onclick="moveProfileScriptRow('${ps.id}', 'down')" ${index === profileScripts.length - 1 ? 'disabled' : ''}>
                    <i class="fas fa-arrow-down"></i>
                </button>
                <span style="font-weight: bold;">${index + 1}.</span>
            </div>
            ${scriptSelect}
            ${machineSelect}
            <button type="button" class="btn btn-sm btn-danger" onclick="removeProfileScriptRow('${ps.id}')">
                <i class="fas fa-times"></i> Удалить
            </button>
        `;
        
        container.appendChild(row);
    });
}

function updateScriptSelection(rowId, scriptId) {
    const ps = profileScripts.find(p => p.id == rowId);
    if (ps) {
        ps.script_id = scriptId;
    }
}

function updateMachineSelection(rowId, selectElement) {
    const ps = profileScripts.find(p => p.id == rowId);
    if (ps) {
        const selectedOptions = Array.from(selectElement.selectedOptions);
        ps.machine_ids = selectedOptions.map(option => option.value);
    }
}

async function saveProfile() {
    const profileId = document.getElementById('profile-id').value;
    const profileName = document.getElementById('profile-name').value;
    
    // Проверяем, что все сценарии выбраны
    const invalidScripts = profileScripts.filter(ps => !ps.script_id || ps.machine_ids.length === 0);
    if (invalidScripts.length > 0) {
        showToast('У всех сценариев должны быть выбраны скрипт и хотя бы одна машина', 'error');
        return;
    }
    
    const profileData = {
        name: profileName,
        scripts: profileScripts.map(ps => ({
            script_id: parseInt(ps.script_id),
            machine_ids: ps.machine_ids.map(id => parseInt(id))
        }))
    };
    
    try {
        let response;
        if (profileId) {
            // Для редактирования - сначала удаляем старые данные, потом добавляем новые
            await fetch(`/api/profiles/${profileId}`, { method: 'DELETE' });
            profileData.id = profileId;
        }
        
        response = await fetch('/api/profiles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profileData)
        });
        
        if (response.ok) {
            showToast(`Профиль ${profileId ? 'обновлен' : 'создан'}`, 'success');
            closeProfileModal();
            loadProfiles();
        } else {
            const error = await response.json();
            showToast(`Ошибка: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error saving profile:', error);
        showToast('Ошибка сохранения профиля', 'error');
    }
}

async function editProfile(profileId) {
    try {
        const response = await fetch(`/api/profiles/${profileId}`);
        const profile = await response.json();
        
        document.getElementById('profile-id').value = profile.id;
        document.getElementById('profile-name').value = profile.name;
        document.getElementById('profile-modal-title').textContent = 'Редактировать профиль';
        
        // Загружаем скрипты профиля
        profileScripts = profile.scripts.map((script, index) => ({
            id: Date.now() + Math.random() + index,
            script_id: script.script_id.toString(),
            machine_ids: script.machine_ids.map(id => id.toString()),
            order_index: index
        }));
        
        renderProfileScripts();
        document.getElementById('profile-modal').style.display = 'flex';
    } catch (error) {
        console.error('Error loading profile:', error);
        showToast('Ошибка загрузки профиля', 'error');
    }
}

async function deleteProfile(profileId) {
    if (!confirm('Вы уверены, что хотите удалить этот профиль?')) return;
    
    try {
        const response = await fetch(`/api/profiles/${profileId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('Профиль удален', 'success');
            loadProfiles();
        } else {
            const error = await response.json();
            showToast(`Ошибка: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error deleting profile:', error);
        showToast('Ошибка удаления профиля', 'error');
    }
}

async function showExecuteProfileModal(profileId) {
    currentProfileId = profileId;
    
    try {
        const response = await fetch(`/api/profiles/${profileId}`);
        const profile = await response.json();
        
        document.getElementById('execute-profile-name').textContent = profile.name;
        
        // Сбрасываем прогресс
        document.getElementById('profile-progress').style.display = 'none';
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-text').textContent = '';
        document.getElementById('execution-log').innerHTML = '';
        document.getElementById('start-execute-btn').disabled = false;
        
        document.getElementById('execute-profile-modal').style.display = 'flex';
    } catch (error) {
        console.error('Error showing execute modal:', error);
        showToast('Ошибка подготовки запуска', 'error');
    }
}

function closeExecuteProfileModal() {
    document.getElementById('execute-profile-modal').style.display = 'none';
    currentProfileId = null;
}

async function executeProfile() {
    if (!currentProfileId) return;
    
    const startBtn = document.getElementById('start-execute-btn');
    startBtn.disabled = true;
    
    // Показываем прогресс
    document.getElementById('profile-progress').style.display = 'block';
    const logContainer = document.getElementById('execution-log');
    
    try {
        const response = await fetch(`/api/profiles/${currentProfileId}/execute`, {
            method: 'POST'
        });
        
        const results = await response.json();
        
        // Обновляем прогресс
        let completed = 0;
        const total = results.length;
        
        results.forEach((result, index) => {
            setTimeout(() => {
                completed++;
                const progress = Math.round((completed / total) * 100);
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `${completed}/${total} выполнено`;

                // Добавляем запись в лог
                const logEntry = document.createElement('div');
                logEntry.style.marginBottom = '0.5rem';
                logEntry.style.padding = '0.5rem';
                logEntry.style.borderRadius = '3px';
                logEntry.style.background = result.success ? '#c6f6d5' : '#fed7d7';
                logEntry.style.border = `1px solid ${result.success ? '#9ae6b4' : '#feb2b2'}`;

                // Находим имя машины и скрипта
                const machineName = machinesCache.find(m => m.id == result.machine_id)?.name || `Машина #${result.machine_id}`;
                const scriptName = scriptsCache.find(s => s.id == result.script_id)?.name || `Сценарий #${result.script_id}`;

                logEntry.innerHTML = `
                    <div style="font-weight: bold;">
                        <i class="fas fa-${result.success ? 'check' : 'times'}"></i>
                        ${scriptName} на ${machineName}
                    </div>
                    ${result.stdout ? `<div style="font-size: 0.8rem; margin-top: 0.25rem;">Вывод: ${result.stdout.substring(0, 100)}${result.stdout.length > 100 ? '...' : ''}</div>` : ''}
                `;

                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // Если все выполнено
                if (completed === total) {
                    setTimeout(() => {
                        showToast('Профиль выполнен', 'success');
                        startBtn.disabled = false;
                    }, 500);
                }
            }, index * 500); // Задержка между выполнениями для наглядности
        });
        
    } catch (error) {
        console.error('Error executing profile:', error);
        showToast('Ошибка выполнения профиля', 'error');
        startBtn.disabled = false;
    }
    closeExecuteProfileModal();
}
</script>

<style>
.profile-script-row {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 5px;
    border: 1px solid #e2e8f0;
}

.script-select,
.machine-select {
    padding: 0.5rem;
    border: 1px solid #cbd5e0;
    border-radius: 5px;
    font-size: 0.9rem;
}

.script-select {
    min-width: 200px;
}

.machine-select {
    min-width: 300px;
    min-height: 100px;
}

.profiles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}
</style>
{% endblock %}