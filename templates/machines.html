              {% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-desktop"></i> Управление машинами</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="showAddMachineModal()">
            <i class="fas fa-plus"></i> Добавить машину
        </button>
        <button class="btn btn-secondary" onclick="testAllMachines()">
            <i class="fas fa-sync"></i> Проверить все
        </button>
    </div>
</div>

<div id="current-machine-alert" class="alert alert-info" style="display: none;">
    <i class="fas fa-info-circle"></i>
    <span id="current-machine-text"></span>
    <button id="add-current-machine-btn" class="btn btn-sm btn-primary" style="margin-left: 10px;">
        Добавить текущую машину
    </button>
</div>

<div class="machines-grid" id="machines-container">
    <!-- Машины будут загружены через JavaScript -->
    <div class="loading">Загрузка машин...</div>
</div>

<!-- Модальное окно добавления/редактирования машины -->
<div id="machine-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Добавить машину</h3>
            <button class="close-btn" onclick="closeMachineModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="machine-form">
                <input type="hidden" id="machine-id">

                <div class="form-group">
                    <label for="machine-name">Название машины *</label>
                    <input type="text" id="machine-name" required>
                </div>

                <div class="form-group">
                    <label for="machine-address">Адрес (IP/домен) *</label>
                    <input type="text" id="machine-address" required>
                </div>

                <div class="form-group">
                    <label for="ssh-port">SSH порт</label>
                    <input type="number" id="ssh-port" value="22" min="1" max="65535">
                </div>

                <div class="form-group">
                    <label for="username">Пользователь *</label>
                    <select id="username" required>
                        <option value="">Выберите пользователя</option>
                    </select>
                    <button type="button" class="btn btn-sm" onclick="showAddUserModal()">
                        <i class="fas fa-plus"></i> Новый пользователь
                    </button>
                </div>

                <div class="form-group">
                    <label for="password">Пароль *</label>
                    <input type="text" id="password" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="testMachineConnection()">
                        <i class="fas fa-plug"></i> Проверить подключение
                    </button>
                    <button type="submit" class="btn btn-primary" id="save-machine-btn" disabled>
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                    <button type="button" class="btn" onclick="closeMachineModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно пользователя -->
<div id="user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Добавить пользователя</h3>
            <button class="close-btn" onclick="closeUserModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="user-form">
                <div class="form-group">
                    <label for="new-username">Логин *</label>
                    <input type="text" id="new-username" required>
                </div>

                <div class="form-group">
                    <label for="new-password">Пароль *</label>
                    <input type="text" id="new-password" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить
                    </button>
                    <button type="button" class="btn" onclick="closeUserModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMachines();
    loadUsers();
    checkCurrentMachine();

    // Обработчик формы машины
    document.getElementById('machine-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveMachine();
    });

    // Обработчик формы пользователя
    document.getElementById('user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveUser();
    });

    // Обработчик кнопки добавления текущей машины
    document.getElementById('add-current-machine-btn').addEventListener('click', function() {
        addCurrentMachine();
    });
});

// Управление пользователями
async function loadUsers() {
    try {
        const response = await fetch('/api/users');
        const users = await response.json();

        const select = document.getElementById('username');
        // Сохраняем текущее значение
        const currentValue = select.value;

        // Очищаем и добавляем опции
        select.innerHTML = '<option value="">Выберите пользователя</option>';
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id; // Сохраняем ID пользователя, а не username
            option.textContent = user.username;
            option.dataset.password = user.password; // Сохраняем пароль в data-атрибуте
            select.appendChild(option);
        });

        // Восстанавливаем значение
        select.value = currentValue;

        // Автоподстановка пароля при выборе пользователя
        if (select.value) {
            autoFillPassword(select.value);
        }

    } catch (error) {
        console.error('Error loading users:', error);
    }
}

// Автозаполнение пароля при выборе пользователя
function autoFillPassword(userId) {
    const select = document.getElementById('username');
    const passwordField = document.getElementById('password');

    if (!select || !passwordField) return;

    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption && selectedOption.dataset.password) {
        passwordField.value = selectedOption.dataset.password;
    } else {
        passwordField.value = '';
    }
}

// Добавляем обработчик изменения пользователя
document.addEventListener('DOMContentLoaded', function() {
    const usernameSelect = document.getElementById('username');
    if (usernameSelect) {
        usernameSelect.addEventListener('change', function() {
            autoFillPassword(this.value);
        });
    }
});
</script>
{% endblock %}